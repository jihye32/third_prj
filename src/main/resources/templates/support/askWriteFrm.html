<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>고객센터</title>
<link th:href="@{/css/output.css}" rel="stylesheet">
<link th:href="@{/css/test.css}" rel="stylesheet">
<style type="text/css">
.ask{
  border:1px solid lightgray;
  border-radius:5px;
  height:50px;
  padding-left:5px;


  width:100%;
  box-sizing:border-box;
  margin-bottom: 15px;
}

#askTitle {
	padding-left: 10px;
}

#askContent{
  height:250px;
  padding-left:10px;
  padding-top:12px;
  width:100%;          
  box-sizing:border-box;
}

#btn {
background-color: #EEEEEE;
border-radius: 5px;
height: 50px;
}
#btnSubmit {
  background-color: #3cb371; 
  color: #f5f5f5;
  border-radius: 5px;
  height: 50px;
  width: 100%;
  cursor: pointer;
}
</style>
<!-- JQuery CDN -->
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript">
$(function () {
  const MAX = 10;
  let selectedFiles = [];

  function updateCount() {
    $("#fileCount").text(selectedFiles.length + "/10");
  }

  function fileKey(f) {
    return `${f.name}_${f.size}_${f.lastModified}`;
  }

  function renderThumbs() {
    const $list = $("#thumbList");
    $list.empty();

    selectedFiles.forEach((file, idx) => {
      const $li = $(`
        <li class="relative w-[68px] h-[68px] lg:w-[100px] lg:h-[100px] border border-jnGray-300 rounded overflow-hidden">
          <img class="w-full h-full object-cover" alt="첨부 이미지 미리보기">
          <button type="button"
                  class="btnRemoveThumb absolute top-1 right-1 bg-black/60 text-white text-xs px-2 py-1 rounded"
                  data-idx="${idx}">X</button>
        </li>
      `);

      const reader = new FileReader();
      reader.onload = (e) => $li.find("img").attr("src", e.target.result);
      reader.readAsDataURL(file);

      $list.append($li);
    });

    updateCount();
  }

  function syncToInputOrFail() {
    const input = document.getElementById("files");

    if (typeof DataTransfer === "undefined") {
      alert("현재 브라우저에서 누적 파일 업로드를 지원하지 않습니다.");
      return false;
    }

    const dt = new DataTransfer();
    selectedFiles.forEach(f => dt.items.add(f));
    input.files = dt.files;

    // ✅ 실제로 주입됐는지 검증
    return input.files && input.files.length === selectedFiles.length;
  }

  // 업로드 버튼 클릭
  $(document).on("click", "#btnPickFiles", function (e) {
    e.preventDefault();
    $("#files").click();
  });

  // 파일 선택(누적)
  $(document).on("change", "#files", function () {
    const picked = this.files ? Array.from(this.files) : [];
    if (picked.length === 0) return;

    if (selectedFiles.length + picked.length > MAX) {
      alert("최대 " + MAX + "장까지 첨부할 수 있어요.");
      this.value = "";
      return;
    }

    // 중복 제거(선택)
    const keys = new Set(selectedFiles.map(fileKey));
    picked.forEach(f => {
      const k = fileKey(f);
      if (!keys.has(k)) {
        selectedFiles.push(f);
        keys.add(k);
      }
    });

    // 같은 파일 다시 고를 수 있게 input 초기화
    this.value = "";

    renderThumbs();
  });

  // 썸네일 삭제(X)
  $(document).on("click", ".btnRemoveThumb", function () {
    const idx = parseInt($(this).data("idx"), 10);
    if (!Number.isNaN(idx)) {
      selectedFiles.splice(idx, 1);
      renderThumbs();
    }
  });

  // 등록 버튼
  $(document).on("click", "#btnSubmit", function (e) {
    e.preventDefault();

    const title = ($("#askTitle").val() || "").trim();
    const text  = ($("#askContent").val() || "").trim();

    if (!title) { alert("문의 제목을 입력해 주세요."); $("#askTitle").focus(); return; }
    if (!text)  { alert("문의 내용을 입력해 주세요."); $("#askContent").focus(); return; }

    // ✅ submit 직전 파일 동기화
    const ok = syncToInputOrFail();

    console.log("selectedFiles=", selectedFiles.length,
                "input.files=", document.getElementById("files").files.length,
                "syncOK=", ok);

    if (!ok) {
      alert("첨부파일 동기화에 실패했습니다. 다시 선택해 주세요.");
      return;
    }

    $("#askForm").submit();
  });

  updateCount();
});
</script>



</head>
<body>
	<div id="__next">
		<div class="flex flex-col min-h-screen bg-white">
			<div th:replace="~{template/header :: headerImgFragment}"></div>
			<div th:replace="~{template/header :: headerFragment}"></div>

			<main class="relative flex-grow border-b-2"
				style="min-height: 500px; padding-bottom: 100px">
				<div
					class="mx-auto max-w-[1280px] px-5 md:px-8 2xl:px-16 box-content">
					<article
						class="flex flex-col justify-center mx-auto mt-6 w-full lg:mt-8 md:w-1/2">
						<div class="flex flex-col space-y-5">
							<h2
								class="text-2xl font-semibold text-jnGray-900 mt-8 text-center">고객센터</h2>
							<div class="h-[1px] bg-jnGray-900 my-5 "></div>
						</div>

						<div class="flex items-center mt-8 mb-4 border-t border-b border-solid border-jnGray-300"
						     style="border-top: 0; margin-top: 0; margin-bottom: 30px">

							<!-- 뒤로가기 -->
							<a th:href="@{/support/askFrm}">
								<svg width="20" height="20" viewBox="0 0 20 20" fill="none"
									xmlns="http://www.w3.org/2000/svg"
									class="rotate-90 rotate-[0deg]">
									<g clip-path="url(#clip0_2224_69059)">
									<path d="M4.25 7L10 12.75L15.75 7" stroke="currentColor"
										stroke-width="1.5" stroke-linecap="round"
										stroke-linejoin="round"></path></g>
									<defs>
									<clipPath id="clip0_2224_69059">
									<rect width="20" height="20" fill="white"></rect></clipPath></defs>
								</svg>
							</a>

							<div class="flex flex-col flex-1 justify-between items-start px-5 py-4 mr-2 w-full"
							     style="margin: 10px 0">
								<span class="text-sm font-normal text-left text-jnGray-900 text-start md:tracking-tight">
									1:1 문의
								</span>
							</div>
						</div>

						<div th:if="${err}" class="text-red-500 text-sm mb-2" th:text="${err}"></div>

						<form id="askForm" method="post" th:action="@{/support/askWriteProcess}" enctype="multipart/form-data">

							<select name="askCode" id="askCode" class="ask" required>
								<option value="N/A">문의 유형을 선택해 주세요.</option>
								<option value="1">결제/환불</option>
								<option value="2">계정/보안</option>
								<option value="3">기타</option>
							</select>
							<br>

							<input type="text" name="askTitle" placeholder="문의 제목을 작성해 주세요." id="askTitle" class="ask" maxlength="100" required>
							<br>

							<textarea name="askText" placeholder="정확한 답변을 위해 문의 내용을 자세히 작성해 주세요." id="askContent" class="ask" maxlength="1000" required></textarea>
							<br>

							<section class="lg:grid lg:grid-cols-6 !text-jnGray-900 max-lg:!mb-8">
								<h2 class="col-span-1 mb-3 text-base lg:text-lg max-lg:py-1 pt-[10px]">사진 첨부</h2>
								<div class="col-span-5">
									<div class="flex pb-1.5 max-lg:pb-0">
										<div class="pt-[10px]">

											<input id="files" name="files" type="file" multiple accept="image/png, image/jpeg, image/jpg, image/webp, image/gif" class="hidden">

											<button id="btnPickFiles"
											        class="flex justify-center items-center mr-3 rounded bg-jnGray-200 lg:w-[100px] lg:h-[100px] w-[68px] h-[68px]">
												<div class="flex flex-col">
													<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" color="#787E89" viewBox="0 0 32 32" class="w-8 h-8 lg:w-12 lg:h-12">
														<path fill="color" d="M19.378 6c.38 0 .73.217.897.559l1.015 2.06q.03.06.05.123H26a2 2 0 0 1 2 2v13.259a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V10.742a2 2 0 0 1 2-2h4.66q.02-.062.05-.123l1.016-2.06A1 1 0 0 1 12.622 6zM16 12.198a5 5 0 1 0 .002 10.002A5 5 0 0 0 16 12.198m-.001 1.667a3.334 3.334 0 1 1 0 6.67 3.334 3.334 0 0 1 0-6.67"></path>
													</svg>
													<p id="fileCount" class="text-jnGray-600 lg:text-base text-xs">0/10</p>
												</div>
											</button>

										</div>

										<div class="overflow-hidden">
											<div class="os-host os-host-foreign os-theme-dark os-host-resize-disabled os-host-scrollbar-horizontal-hidden os-host-scrollbar-vertical-hidden os-host-transition">
												<div class="os-padding">
													<div class="os-viewport os-viewport-native-scrollbars-invisible os-viewport-native-scrollbars-overlaid">
														<div class="os-content" style="padding: 0px; height: auto; width: 100%; float: left;">
															<ul id="thumbList" class="flex items-center pt-[10px] gap-2 flex-wrap"></ul>

														</div>
													</div>
												</div>
												<div class="os-scrollbar-corner"></div>
											</div>
										</div>

									</div>
								</div>
							</section>

							<br>

							
							<input type="button" value="등록" id="btnSubmit" style="width:100%;" class="ask">

						</form>

					</article>
				</div>
			</main>

			<div th:replace="~{template/footer :: footerFragment}"></div>
		</div>
	</div>
</body>
</html>
