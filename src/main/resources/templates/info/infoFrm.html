<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>내 정보</title>
<link th:href="@{/css/output.css}" rel="stylesheet">
<link th:href="@{/css/test.css}" rel="stylesheet">
<style type="text/css">
.chkBtn {
    width: 200px;
    height: 50px;
    border-radius: 5px;
	background-color: #0DCC5A;
	color: white;
	margin-left: 10px;
	font-weight: bold;
	position: absolute;
	right: 0;
}
</style>
<!-- JQuery CDN -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript">
$(function() {
    // 기존 데이터 저장 (수정 여부 비교용)
    const originStoreName = $("#storeName").val().trim();
    const originEmailLocal = $("#emailLocal").val().trim();
    const originEmailDomain = $("#emailDomain").val();

    // 플래그 설정 (기존 값과 같으면 이미 인증된 것으로 간주)
    let isStoreNameChecked = true; 
    let isEmailVerified = true;
    
 	// 정규표현식 정의
    const idReg = /^[a-zA-Z0-9]{6,12}$/;
    const passReg = /^[a-zA-Z0-9!@#$%^&*()_+|<>?:{}]{8,15}$/;

    // 1. 가게명 수정 감지 및 중복 확인
    $("#storeName").on("input", function() {
        const currentStoreName = $(this).val().trim();
        if (currentStoreName === originStoreName) {
            isStoreNameChecked = true;
            $("#storeNameChkMsg").text("기존 가게명입니다.").css("color", "blue");
        } else {
            isStoreNameChecked = false;
            $("#storeNameChkMsg").text("가게명 중복 확인이 필요합니다.").css("color", "orange");
        }
    });

    $("#storeNameChkBtn").click(function() {
        const storeName = $("#storeName").val().trim();
        if (storeName === "") {
            alert("가게명을 입력해주세요.");
            return;
        }
        if (storeName === originStoreName) {
            alert("기존 가게명과 동일합니다.");
            return;
        }

        $.ajax({
            url: "/info/storeNameDup",
            type: "GET",
            data: { storeName: storeName },
            success: function(isAvailable) {
                if (isAvailable) {
                    $("#storeNameChkMsg").text("사용 가능한 가게명입니다.").css("color", "#0DCC5A");
                    isStoreNameChecked = true;
                    
                    $("input[name='storeName']").attr("readonly", true).css("background-color", "#F5F5F5");
                    $("#storeNameChkBtn").attr("disabled", true).css("opacity", "0.5").css("cursor", "default");
                } else {
                    $("#storeNameChkMsg").text("이미 사용 중인 가게명입니다.").css("color", "red");
                    isStoreNameChecked = false;
                }
            },
            error: function() {
                alert("가게명 중복 확인 중 오류가 발생했습니다.");
            }
        });
    });

    // 2. 이메일 수정 감지 및 인증
    $("#emailLocal, #emailDomain").on("input change", function() {
        const currentEmailLocal = $("#emailLocal").val().trim();
        const currentEmailDomain = $("#emailDomain").val();

        if (currentEmailLocal === originEmailLocal && currentEmailDomain === originEmailDomain) {
            isEmailVerified = true;
            $("#sendVerifyCodeMsg").text("기존 이메일입니다.").css("color", "blue");
        } else {
            isEmailVerified = false;
            $("#sendVerifyCodeMsg").text("이메일 변경 시 재인증이 필요합니다.").css("color", "orange");
        }
    });

    // 인증번호 전송
    $("#sendVerifyCodeBtn").click(function() {
        const emailLocal = $("#emailLocal").val().trim();
        const emailDomain = $("#emailDomain").val();

        if (emailLocal === "") {
            alert("이메일을 입력해주세요.");
            return;
        }

        $("#sendVerifyCodeMsg").text("인증번호 발송 중...").css("color", "black");

        $.ajax({
            url: "/info/sendVerifyCode",
            type: "GET",
            data: { emailLocal: emailLocal, emailDomain: emailDomain },
            success: function(result) {
                if (result) {
                    $("#sendVerifyCodeMsg").text("인증번호가 발송되었습니다.").css("color", "#0DCC5A");
                } else {
                    $("#sendVerifyCodeMsg").text("발송 실패. 다시 시도해주세요.").css("color", "red");
                }
            }
        });
    });

    // 인증번호 확인
    $("#verifyCodeChkBtn").click(function() {
        const inputCode = $("input[name='inputCode']").val().trim(); // name 속성 확인 필요
        if (inputCode === "") {
            alert("인증번호를 입력해주세요.");
            return;
        }

        $.ajax({
            url: "/info/verifyCodeChk",
            type: "POST",
            data: { inputCode: inputCode },
            success: function(isMatch) {
                if (isMatch) {
                    $("#verifyCodeChkMsg").text("인증에 성공했습니다.").css("color", "#0DCC5A");
                    isEmailVerified = true;

                    $("input[name='emailLocal']").attr("readonly", true).css("background-color", "#F5F5F5");
                    $("select[name='emailDomain']").attr("disabled", true).css("background-color", "#F5F5F5");
                    $("input[name='inputCode']").attr("readonly", true).css("background-color", "#F5F5F5");
                    
                    $("#sendVerifyCodeBtn, #verifyCodeChkBtn").attr("disabled", true).css("opacity", "0.5").css("cursor", "default");
                } else {
                    $("#verifyCodeChkMsg").text("인증번호가 일치하지 않습니다.").css("color", "red");
                    isEmailVerified = false;
                }
            },
            error: function() {
                alert("인증 확인 중 오류가 발생했습니다.");
            }
        });
    });

    // 3. 최종 수정하기 버튼
    $("#changeInfoBtn").click(function() {
        // 필수 체크
        if (!isStoreNameChecked) {
            alert("가게명 중복 확인을 진행해주세요.");
            return;
        }
        if (!isEmailVerified) {
            alert("이메일 인증을 완료해주세요.");
            return;
        }

        // 비밀번호 변경 시 일치 여부 확인
        const pass = $("#pass").val();
        const passChk = $("#passChk").val();
        if (pass !== "" || passChk !== "") {
            if (pass !== passChk) {
                alert("새 비밀번호가 일치하지 않습니다.");
                return;
            }
            
         	// 비밀번호 유효성 검사 (8~15자, 영문/숫자/특수문자)
            if(!passReg.test(pass)) {
                alert("비밀번호는 영문 대소문자와 숫자, 특수문자를 사용하여 8~15자리로 입력해주세요.");
                $("input[name='pass']").focus();
                return;
            }
        }

        if (confirm("정보를 수정하시겠습니까?")) {
        	$("select[name='emailDomain']").attr("disabled", false);
            $("#infoFrm").submit();
        }
    });
});// ready
</script>
</head>
<body>
	<div id="__next">
		<div class="flex flex-col min-h-screen bg-white">
			<div th:replace="~{template/header :: headerImgFragment}"></div>
			<div th:replace="~{template/header :: headerFragment}"></div>

			<main class="relative flex-grow border-b-2"
				style="min-height: 0px !important; height: auto !important; padding-bottom: 100px">
				<div
					class="mx-auto max-w-[1280px] md:px-8 2xl:px-16 box-content max-lg:overflow-x-hidden px-0">
					<div></div>
					<form th:action="@{/info/changeInfoProcess}" method="post" id="infoFrm"
						class="pt-6 mx-auto w-full max-w-[1020px] lg:pt-[72px] max-lg:overflow-x-hidden">
						<section class="px-5">
							<div
								class="relative pb-2 mb-3 text-lg font-semibold lg:pb-2.5 lg:mb-5 lg:text-2xl before:content-[''] before:absolute before:left-0 before:bottom-0 before:w-full before:h-[1px] before:bg-jnGray-900 !text-jnGray-900"
								style="margin-bottom: 50px">
								<h1>내 정보</h1>
							</div>
							<div class="flex flex-col space-y-4 lg:space-y-8 mb-[76px] lg:mb-[72px]">
								<!-- 아이디 -->
								<section
									class="lg:grid lg:grid-cols-6 !text-jnGray-900 max-lg:!mt-0 max-lg:!mb-8">
									<h2 class="col-span-1 mb-3 text-base font-semibold lg:text-lg max-lg:py-1 flex items-center justify-between gap-0.5 lg:block">아이디</h2>
									<div class="col-span-5">
										<div class="relative">
											<div class="relative">
												<input id="id" name="id" type="text" th:value="${md.user_id}" disabled class="py-2 px-4 md:px-5 w-full appearance-none border text-input text-xs lg:text-sm font-body placeholder-body transition duration-200 ease-in-out bg-white border-gray-300 focus:border-heading h-11 md:h-12 body-medium-14 !h-11 !p-3 !pr-8 overflow-x-scroll min-h-fit lg:body-medium-16 lg:!h-12 placeholder:text-jnGray-500 focus:outline-none rounded"
													autocomplete="off" spellcheck="false" aria-invalid="false">
											</div>
										</div>
									</div>
								</section>
								<!-- 비밀번호 -->
								<section
									class="lg:grid lg:grid-cols-6 !text-jnGray-900 max-lg:!mt-0 max-lg:!mb-8">
									<h2 class="col-span-1 mb-3 text-base font-semibold lg:text-lg max-lg:py-1 flex items-center justify-between gap-0.5 lg:block">새
										비밀번호</h2>
									<div class="col-span-5">
										<div class="relative">
											<div class="relative">
												<input id="pass" name="pass" type="password" placeholder="영문/숫자/특수문자 8~15자"
													class="py-2 px-4 md:px-5 w-full appearance-none border text-input text-xs lg:text-sm font-body placeholder-body transition duration-200 ease-in-out bg-white border-gray-300 focus:border-heading h-11 md:h-12 body-medium-14 !h-11 !p-3 !pr-8 overflow-x-scroll min-h-fit lg:body-medium-16 lg:!h-12 placeholder:text-jnGray-500 focus:outline-none rounded"
													autocomplete="off" spellcheck="false" aria-invalid="false">
											</div>
										</div>
									</div>
								</section>
								<!-- 비밀번호 확인 -->
								<section
									class="lg:grid lg:grid-cols-6 !text-jnGray-900 max-lg:!mt-0 max-lg:!mb-8">
									<h2 class="col-span-1 mb-3 text-base font-semibold lg:text-lg max-lg:py-1 flex items-center justify-between gap-0.5 lg:block">새
										비밀번호 확인</h2>
									<div class="col-span-5">
										<div class="relative">
											<div class="relative">
												<input id="passChk" name="passChk" type="password" 
													class="py-2 px-4 md:px-5 w-full appearance-none border text-input text-xs lg:text-sm font-body placeholder-body transition duration-200 ease-in-out bg-white border-gray-300 focus:border-heading h-11 md:h-12 body-medium-14 !h-11 !p-3 !pr-8 overflow-x-scroll min-h-fit lg:body-medium-16 lg:!h-12 placeholder:text-jnGray-500 focus:outline-none rounded"
													autocomplete="off" spellcheck="false" aria-invalid="false">
											</div>
										</div>
									</div>
								</section>
								<!-- 이름 -->
								<section
									class="lg:grid lg:grid-cols-6 !text-jnGray-900 max-lg:!mt-0 max-lg:!mb-8">
									<h2 class="col-span-1 mb-3 text-base font-semibold lg:text-lg max-lg:py-1 flex items-center justify-between gap-0.5 lg:block">이름</h2>
									<div class="col-span-5">
										<div class="relative">
											<div class="relative">
												<input id="name" name="name" type="text" th:value="${md.name}" disabled class="py-2 px-4 md:px-5 w-full appearance-none border text-input text-xs lg:text-sm font-body placeholder-body transition duration-200 ease-in-out bg-white border-gray-300 focus:border-heading h-11 md:h-12 body-medium-14 !h-11 !p-3 !pr-8 overflow-x-scroll min-h-fit lg:body-medium-16 lg:!h-12 placeholder:text-jnGray-500 focus:outline-none rounded"
													autocomplete="off" spellcheck="false" aria-invalid="false">
											</div>
										</div>
									</div>
								</section>
								<!-- 가게명 -->
								<section
									class="lg:grid lg:grid-cols-6 !text-jnGray-900 max-lg:!mt-0 max-lg:!mb-8">
									<h2 class="col-span-1 mb-3 text-base font-semibold lg:text-lg max-lg:py-1 flex items-center justify-between gap-0.5 lg:block">새 가게명</h2>
									<div class="col-span-5">
										<div class="relative">
											<div class="relative">
												<input style="width: 600px;" id="storeName" name="storeName" type="text" th:value="${md.store_name}" class="py-2 px-4 md:px-5 w-full appearance-none border text-input text-xs lg:text-sm font-body placeholder-body transition duration-200 ease-in-out bg-white border-gray-300 focus:border-heading h-11 md:h-12 body-medium-14 !h-11 !p-3 !pr-8 overflow-x-scroll min-h-fit lg:body-medium-16 lg:!h-12 placeholder:text-jnGray-500 focus:outline-none rounded"
													autocomplete="off" spellcheck="false" aria-invalid="false">
									        	<input type="button" value="중복확인" class="chkBtn cursor-pointer" id="storeNameChkBtn">
									        	<!-- 가게명 중복확인 메시지 -->
												<div id="storeNameChkMsg" style="font-size: 0.8em; margin-top: 5px;"></div>
											</div>
										</div>
									</div>
								</section>
								<!-- 생년월일 -->
								<section
									class="lg:grid lg:grid-cols-6 !text-jnGray-900 max-lg:!mt-0 max-lg:!mb-8">
									<h2 class="col-span-1 mb-3 text-base font-semibold lg:text-lg max-lg:py-1 flex items-center justify-between gap-0.5 lg:block">생년월일</h2>
									<div class="col-span-5">
										<div class="relative">
											<div class="relative">
												<input id="birthday" name="birthday" type="text" th:value="${md.birthday}" disabled class="py-2 px-4 md:px-5 w-full appearance-none border text-input text-xs lg:text-sm font-body placeholder-body transition duration-200 ease-in-out bg-white border-gray-300 focus:border-heading h-11 md:h-12 body-medium-14 !h-11 !p-3 !pr-8 overflow-x-scroll min-h-fit lg:body-medium-16 lg:!h-12 placeholder:text-jnGray-500 focus:outline-none rounded"
													autocomplete="off" spellcheck="false" aria-invalid="false">
											</div>
										</div>
									</div>
								</section>
								<!-- 이메일 -->
								<section
									class="lg:grid lg:grid-cols-6 !text-jnGray-900 max-lg:!mt-0 max-lg:!mb-8">
									<h2 class="col-span-1 mb-3 text-base font-semibold lg:text-lg max-lg:py-1 flex items-center justify-between gap-0.5 lg:block">새 이메일</h2>
									<div class="col-span-5">
										<div class="relative">
											<div class="relative">
												<input style="width: 345px;" id="emailLocal" name="emailLocal" type="text" th:value="${#strings.substringBefore(md.email, '@')}"
													class="py-2 px-4 md:px-5 w-full appearance-none border text-input text-xs lg:text-sm font-body placeholder-body transition duration-200 ease-in-out bg-white border-gray-300 focus:border-heading h-11 md:h-12 body-medium-14 !h-11 !p-3 !pr-8 overflow-x-scroll min-h-fit lg:body-medium-16 lg:!h-12 placeholder:text-jnGray-500 focus:outline-none rounded"
													autocomplete="off" spellcheck="false" aria-invalid="false">
												<select style="width: 250px;" id="emailDomain" name="emailDomain" class="py-2 px-4 md:px-5 w-full border text-input text-xs lg:text-sm font-body placeholder-body transition duration-200 ease-in-out bg-white border-gray-300 focus:border-heading h-11 md:h-12 body-medium-14 !h-11 !p-3 !pr-8 overflow-x-scroll min-h-fit lg:body-medium-16 lg:!h-12 placeholder:text-jnGray-500 focus:outline-none rounded">
													<option value="@naver.com" th:selected="${#strings.substringAfter(md.email, '@') == 'naver.com'}">@naver.com</option>
													<option value="@gmail.com" th:selected="${#strings.substringAfter(md.email, '@') == 'gmail.com'}">@gmail.com</option>
													<option value="@daum.net" th:selected="${#strings.substringAfter(md.email, '@') == 'daum.net'}">@daum.net</option>
												</select>
												<input type="button" value="인증번호 전송" class="chkBtn cursor-pointer" id="sendVerifyCodeBtn">
												<!-- 이메일 인증번호 전송 확인 메시지 -->
												<div id="sendVerifyCodeMsg" style="font-size: 0.8em; margin-top: 5px;"></div>
											</div>
										</div>
									</div>
								</section>
								<!-- 이메일 인증번호 -->
								<section
									class="lg:grid lg:grid-cols-6 !text-jnGray-900 max-lg:!mt-0 max-lg:!mb-8">
									<h2
										class="col-span-1 mb-3 text-base font-semibold lg:text-lg max-lg:py-1 flex items-center justify-between gap-0.5 lg:block">인증번호</h2>
									<div class="col-span-5">
										<div class="relative">
											<div class="relative">
												<input style="width: 600px;" id="inputCode" name="inputCode" type="text"
													placeholder=""
													class="py-2 px-4 md:px-5 w-full appearance-none border text-input text-xs lg:text-sm font-body placeholder-body transition duration-200 ease-in-out bg-white border-gray-300 focus:border-heading h-11 md:h-12 body-medium-14 !h-11 !p-3 !pr-8 overflow-x-scroll min-h-fit lg:body-medium-16 lg:!h-12 placeholder:text-jnGray-500 focus:outline-none rounded"
													autocomplete="off" spellcheck="false" aria-invalid="false">
									        	<input type="button" value="인증하기" class="chkBtn cursor-pointer" id="verifyCodeChkBtn" name="verifyCodeChkBtn">
									        	<!-- 이메일 인증번호 인증 확인 메시지 -->
												<div id="verifyCodeChkMsg" style="font-size: 0.8em; margin-top: 5px;"></div>
											</div>
										</div>
									</div>
								</section>
							</div>
						</section>
						<div
							class="flex fixed bottom-0 left-0 z-10 flex-col items-center w-full bg-white lg:relative">
							<div class="w-full px-5 py-3 max-w-[1020px]">
								<button data-variant="flat"
									class="text-[13px] md:text-sm leading-4 inline-flex items-center cursor-pointer transition ease-in-out duration-300 font-semibold font-body text-center justify-center border-0 border-transparent placeholder-white focus-visible:outline-none focus:outline-none rounded-md bg-heading text-white px-5 md:px-6 lg:px-8 py-4 md:py-3.5 lg:py-4 hover:text-white hover:bg-gray-600 hover:shadow-cart w-full break-keep"
									type="button" id="changeInfoBtn">수정하기</button>
							</div>
						</div>
					</form>
				</div>
				<div class="Toastify"></div>
			</main>

			<div th:replace="~{template/footer :: footerFragment}"></div>
		</div>
	</div>
	<div th:replace="~{template/wrapper_frm :: drawerFrame}"></div>
</body>
</html>