<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>중고마켓 관리자센터 - 매출관리</title>
<!-- bootstrap CDN 시작 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<!-- bootstrap CDN 끝 -->
 <link rel="stylesheet" th:href="@{/css/style.css}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<style>
<!-- /* style.css */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #fff; }

/* [상단바] 카카오 다크 네이비 스타일 */
/* 상단바 기본 설정 수정 */
#kakaoHead {
    position: fixed; top: 0; left: 0; width: 100%; height: 60px;
    background-color: #0c193a;
    display: flex; 
    align-items: center; 
    justify-content: space-between; /* 로고와 버튼을 양 끝으로 배치 */
    padding: 0 25px; 
    z-index: 1000;
}



</style> 

<style type="text/css">
.container{display:flex; gap:10px;text-align:center;}
.item{padding:0px; text-align:center;}

.border {
  width : 100%;
  height: 500px;
  background-color: #FFFFE0;
  border: 1px solid red;
}

.search{
 position: relative;
 left:300px;
}
</style>

<script>


function validateAndSubmit() {
    const input = document.getElementById('chargeInput');
    const val = input.value.trim();
    
    const doubleRegex = /^[0-9]+(\.[0-9]+)?$/;

    if (!doubleRegex.test(val)) {
        alert("유효한 수수료율을 입력해주세요. (숫자만 가능)");
        input.focus();
        return false; // 
    }

    if (confirm("정말 수수료율을 " + val + "%로 수정하시겠습니까?")) {
        // 확인을 누른 경우에만 폼 제출
        document.getElementById('chargeForm').submit();
    } else {
    	
    }
}

</script>
<body>

 <header th:replace="manage/common_layout :: header"></header>

<div class="wrapper">
    <aside th:replace="manage/common_layout :: sidebar"></aside>

        <main id="main-container">
            
         <h5><span th:text="${now}"></span> 기준</h5> 
          
          <div class="bg-body-tertiary p-5 rounded" style="text-align:center"> 
          <div class="container">
         	 <div class="item">
         	 오늘 안전결제(건)<br>
        	  <span th:text="${safepayToday}"></span>
         	 </div>
         	 <div class="item">
         	 어제 안전결제(건)<br>
        	   <span th:text="${safepayYesterday}"></span>
         	 </div>
         	 <div class="item">
         	 이번 달 안전결제(건)<br>
        	   <span th:text="${safepayMonth}"></span>
         	 </div>|
          
         <div class="item">
         	 오늘 매출<br>
        	 <span th:text="${chargeToday}"></span>
         	 </div>
         	 <div class="item">
         	 어제 매출<br>
        	 <span th:text="${chargeYesterday}"></span>
         	 </div>
         	 <div class="item">
         	 이번 달 매출<br>
        	  <span th:text="${chargeMonth}"></span>
         	 </div>|
         
        <form id="chargeForm" th:action="@{/insert-charge}" method="post">
    <div class="item" id="charge">
        안전결제 수수료(%) 설정<br>
        <div>
            <input type="text" id="chargeInput" name="chargeNow" 
                   th:value="${chargeNow}" 
                   style="width:150px; height:30px" 
                   placeholder="숫자만 입력 (예: 3.5)"> %
            
            <input type="button" value="변경" onclick="validateAndSubmit()">
        </div>
        <p id="errorMsg" style="color:red; font-size:12px; display:none;">
            정수 또는 소수점 숫자만 입력해주세요.
        </p>
    </div>
</form>

         	
         </div>
         </div>
 
          
  <div class="border"><br>
  <div class="container"><br>
  <div class="item">
 <h2>월별 매출 통계</h2> 
  </div>
  <div class="search">
    
<form action="/manage/sales" method="get" class="search"> 
<!-- 가데이터 표본이 적어서 카테고리 선택 넣을지 말지 선택 -->
<!-- <select name="category"> <option value="">카테고리 선택</option> 
<option th:each="cate : ${categoryList}" th:value="${cate}" th:text="${cate}"></option> </select> -->
 <input type="month" name="currentMonth" th:value="${currentMonth}"> <input type="submit" value="조회">
  </form>
  
  </div>
  
  
  
  </div>
  <br>
  <div class="container">
  
  <div  style="height:300px; width:500px; text-align:center">
  <canvas id="horizontalBar1"></canvas>
  </div>
  <div  style="height:300px; width:500px; text-align:center">
  <canvas id="horizontalBar2"></canvas>
  </div>
  </div> 
  </div>

<br>         
  
       

  
  
  <div class="container">
 
  <div class="item" style="height:300px; width:350px">
 <h5>결제 방법 비율</h5>
  <canvas id="circleChart" style="text-align:center"></canvas>

  </div>
  
   
  
  <div id="line" style="height:300px; width:600px; text-align:center">
   <h5>지난 해 수수료 매출</h5>
  <canvas id="lineChart"></canvas>

  </div> 
  
    
<script th:inline="javascript">
const rawData = /*[[${lastYearChargeList}]]*/ [] || []; // 데이터가 없으면 빈 배열로 초기화

const monthlyData = new Array(12).fill(0);

// 데이터가 있을 때만 루프 실행
if (rawData && rawData.length > 0) {
    rawData.forEach(item => {
        // 대소문자 방어 코드: MONTH 또는 month 둘 다 체크
        const mStr = item.MONTH || item.month;
        const sVal = item.TOTAL_SALES || item.total_sales || 0;
        
        const m = parseInt(mStr); 
        
        if (!isNaN(m) && m >= 1 && m <= 12) {
            monthlyData[m - 1] = sVal; 
        }
    });
}

// 4. Chart.js 설정
const ctx = document.getElementById('lineChart');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
        datasets: [{
            label: '작년 월별 수수료 합계',
            data: monthlyData, // 가공한 배열 주입
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    // 숫자에 콤마(,) 추가
                    callback: function(value) {
                        return value.toLocaleString() + '원';
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '원';
                    }
                }
            }
        }
    }
});
		
const ctx2 = document.getElementById('horizontalBar1');
const safepayMonthNow = /*[[${safepayMonthNow}]]*/ 0;
const safepayMonthLast = /*[[${safepayMonthLast}]]*/ 0;
const myChart2 = new Chart(ctx2, {
    type: 'bar',
    data: {
        labels: ['이번 달', '지난 달'],
        datasets: [{
            label: '안전결제 건 수',
            data: [safepayMonthNow, safepayMonthLast],
            backgroundColor: [
                'rgba(54, 162, 235, 0.6)',
                'rgba(201, 203, 207, 0.6)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y', // ⭐ 가로 막대
        scales: {
            x: {
                beginAtZero: true
            }
        }
    }
});

const ctx3 = document.getElementById('horizontalBar2');
const chargeMonthNow = /*[[${chargeMonthNow}]]*/ 0;
const chargeMonthLast = /*[[${chargeMonthLast}]]*/ 0;
const myChart3 = new Chart(ctx3, {
    type: 'bar',
    data: {
        labels: ['이번 달', '지난 달'],
        datasets: [{
            label: '매출액(원)',
            data: [chargeMonthNow, chargeMonthLast],
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(201, 203, 207, 0.6)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        scales: {
            x: {
                beginAtZero: true
            }
        }
    }
});

		
</script>  
  
  </div> 
       
       
        </main>
    </div>
<script th:inline="javascript">
  const pie = document.getElementById('circleChart');
  const allPay = /*[[${allPayMethod}]]*/ 0;   
  const safepay = /*[[${selectPayMethod}]]*/ 0;
  new Chart(pie, {
    type: 'pie',
    data: {
      labels: ['안전결제', '사용자 간 송금'],
      datasets: [{
        //label: '비율',
        data: [safepay,allPay-safepay],
        borderWidth: 1
      }]
    }
  });
</script>
</body>
</html>