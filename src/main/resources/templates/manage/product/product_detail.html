<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>중고마켓 관리자센터 - 물품상세</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" type="text/css"
	th:href="@{/css/manager_product_detail.css}">
<link rel="stylesheet" th:href="@{/css/style.css}">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
</style>
</head>
<body>
	<header th:replace="~{manage/common_layout :: header}"></header>

	<div class="wrapper">
		<aside th:replace="~{manage/common_layout :: sidebar}"></aside>

		<main id="main-container">
			<div class="detail-inner-wrap">
				<div class="d-flex justify-content-between align-items-center mb-4">
					<button
						style="background: #f4f6f8; padding: 6px 16px; border-radius: 4px; font-weight: bold;"
						th:onclick="|location.href='/manage/product/product_main'|">돌아가기</button>

					<div class="d-flex align-items-stretch">
						<button class="btn-del-red" id="deleteBtn"
							th:disabled="${product?.status_code == 2 or product?.status_code == 3}"
							onclick="deleteProduct()">상품 삭제</button>

						<select class="form-select sel-del-reason" id="deleteReason"
							onchange="toggleDeleteButton()"
							th:if="${product?.status_code != 2 and product?.status_code != 3}">
							<option value="" selected>상품 삭제 사유</option>
							<option value="1">사기로 의심됨</option>
							<option value="2">부적절한 물품</option>
							<option value="3">검색 노출 조작 및 도배</option>
							<option value="4">현금 외 거래 유도</option>
							<option value="5">기타 사유</option>
						</select>

						<div th:if="${product?.status_code == 2}"
							class="ms-3 d-flex align-items-center text-danger small fw-bold">
							<i class="bi bi-exclamation-triangle-fill me-1"></i> 거래 중인 상품은
							삭제할 수 없습니다.
						</div>
						<div th:if="${product?.status_code == 3}"
							class="ms-3 d-flex align-items-center text-danger small fw-bold">
							<i class="bi bi-exclamation-triangle-fill me-1"></i> 거래 완료된 상품은
							삭제할 수 없습니다.
						</div>
					</div>
				</div>

				<div class="top-layout">
					<div class="img-fixed-box">
						<img id="mainImg"
							th:src="${product?.thumbnail != null ? '/images/thumbnail/' + product.thumbnail : '/images/product_detail/default.jpg'}"
							onerror="this.src='/images/product_detail/default.jpg';">

						<div class="slider-controls"
							th:if="${product?.product_images != null and !product.product_images.empty}">
							<button type="button" class="btn-prev" onclick="changeImg(-1)">
								<i class="bi bi-chevron-left"></i>
							</button>
							<button type="button" class="btn-next" onclick="changeImg(1)">
								<i class="bi bi-chevron-right"></i>
							</button>
						</div>

						<div class="img-status-overlay"
							th:if="${product?.status_code == 2 or product?.status_code == 3}">
							<span th:text="${product.status_code == 2 ? '예약중' : '판매완료'}"></span>
						</div>

						<div class="img-count-tag" id="imgTag">1 / 1</div>
					</div>
					<div class="info-box">
						<h2 class="fw-bold" th:text="${product?.title}"></h2>
						<div class="price-val">
							<span
								th:text="${product != null ? #numbers.formatInteger(product.price, 3, 'COMMA') : '0'}"></span>원
						</div>
						<div class="stats-row">
							<span><i class="bi bi-heart"></i>
								[[${product?.bookmark_count ?: 0}]]</span> <span><i
								class="bi bi-eye"></i> [[${product?.view_count ?: 0}]]</span> <span><i
								class="bi bi-clock"></i> [[${product?.time_string ?: '-'}]]</span>
						</div>
						<table class="detail-table">
							<tr>
								<th>· 상품상태</th>
								<td th:text="${product?.product_status}"></td>
							</tr>
							<tr>
								<th>· 직거래지역</th>
								<td th:text="${product?.addr}"></td>
							</tr>
						</table>
					</div>
				</div>

				<div class="bottom-layout">
					<div class="content-col">
						<div class="section-head">상품정보</div>
						<div class="desc-content" th:text="${product?.description}"></div>

						<div class="icon-bar">
							<div class="icon-item">
								<i class="bi bi-geo-alt"></i><span class="label">직거래지역</span><span
									class="val" th:text="${product?.addr}"></span>
							</div>
							<div class="icon-item">
								<i class="bi bi-list-task"></i><span class="label">카테고리</span> <span
									class="val" th:switch="${product?.category_code}"> <span
									th:case="1">전자기기</span> <span th:case="2">패션/의류</span> <span
									th:case="3">잡화</span> <span th:case="4">취미/게임</span> <span
									th:case="5">뷰티</span> <span th:case="6">리빙/생활</span> <span
									th:case="7">스포츠</span> <span th:case="8">티켓/쿠폰</span> <span
									th:case="9">레저/여행</span> <span th:case="10">가전제품</span> <span
									th:case="*">-</span>
								</span>
							</div>
						</div>

						<div class="trans-info-box" th:if="${product?.status_code == 3}">
							<div class="trans-title">거래 정보</div>
							<table class="trans-table"
								th:if="${product.destination_addr != null}">
								<tr>
									<th>구매자 ID</th>
									<td th:text="${product.buyer_id}"></td>
								</tr>
								<tr>
									<th>발송지</th>
									<td th:text="${product.addr}"></td>
								</tr>
								<tr>
									<th>수령지</th>
									<td class="fw-bold text-primary"
										th:text="${product.destination_addr + ' ' + product.destination_detail}"></td>
								</tr>
							</table>
							<div th:unless="${product.destination_addr != null}"
								class="alert alert-light border d-flex align-items-center mb-0">
								<i class="bi bi-geo-fill fs-4 me-3 text-secondary"></i>
								<div>
									<div class="fw-bold text-secondary">직거래된 상품입니다.</div>
									<div class="small text-muted">구매자([[${product.buyer_id}]])와
										대면하여 거래를 완료하였습니다.</div>
								</div>
							</div>
						</div>
					</div>

					<div class="shop-col">
						<div class="section-head">상점정보</div>
						<div class="d-flex align-items-center">
							<div
								class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3"
								style="width: 50px; height: 50px; border: 1px solid #eee;">
								<i class="bi bi-shop fs-4"></i>
							</div>
							<div>
								<div class="fw-bold" th:text="${product?.store_name}"></div>
								<div class="small text-muted">입점 상점</div>
							</div>
						</div>
						<a
							th:href="@{/manage/member/member_prdv(userId=${product.user_id})}"
							class="btn-list-navy text-center d-inline-block text-decoration-none"
							style="line-height: 35px;"> 상점으로 </a>
					</div>
				</div>
			</div>
		</main>
	</div>

	<script th:inline="javascript">
    $(document).ready(function() {
        // ✅ 사이드바 활성화 로직 (현재 위치 강조)
        const currentPath = window.location.pathname;
        if (currentPath.includes('/manage/product')) {
            $('a[href*="product"]').closest('.menu_item').addClass('active');
        }
        
        toggleDeleteButton(); // 초기 상태 체크
    });

    /**
     * 사유 선택 시 버튼 활성화 제어
     */
    function toggleDeleteButton() {
        const statusCode = [[${product?.status_code}]];
        const reason = document.getElementById('deleteReason')?.value || "";
        const btn = document.getElementById('deleteBtn');
        
        if (statusCode == 2 || statusCode == 3) {
            btn.disabled = true;
            return;
        }

        // 사유가 선택되었을 때만 버튼 활성화
        btn.disabled = (reason === "");
    }

    /**
     * 실제 상품 삭제 처리
     */
    function deleteProduct() {
        const deleteReason = document.getElementById('deleteReason').value;
        if (!deleteReason) {
            alert("삭제 사유를 선택해주세요.");
            return;
        }
        
        if (!confirm("정말 이 상품을 삭제하시겠습니까?")) return;

        const productNo = [[${product?.product_num}]];

        $.ajax({
            url: '/manage/product/delete_product',
            type: 'POST',
            data: {
            	product_num: productNo, 
                delete_text: deleteReason
            },
            success: function(res) {
                if(res === "success") {
                    alert("상품이 성공적으로 삭제되었습니다.");
                    location.href = "/manage/product/product_main";
                } else {
                    alert("삭제 처리에 실패했습니다.");
                }
            },
            error: function() {
                alert("서버 통신 중 에러가 발생했습니다.");
            }
        });
    }
    
    /* 이미지 리스트 초기화 */
    let imgList = [];
    let currIdx = 0;

    $(document).ready(function() {
        const thumbnail = [[${product?.thumbnail}]];
        const detailImgs = [[${product?.product_images}]]; // List<String> 형태

        // 1. 썸네일을 첫 번째로 넣기 (경로 식별을 위해 객체로 저장)
        if(thumbnail) {
            imgList.push({ path: '/images/thumbnail/', file: thumbnail });
        }

        // 2. 상세 이미지들을 뒤에 붙이기
        if(detailImgs && detailImgs.length > 0) {
            detailImgs.forEach(img => {
                imgList.push({ path: '/images/product_detail/', file: img });
            });
        }

        // 초기 인디케이터 설정
        updateImgTag();
    });

    function changeImg(step) {
        if(imgList.length <= 1) return;

        currIdx += step;

        // 무한 슬라이드 처리
        if(currIdx < 0) currIdx = imgList.length - 1;
        if(currIdx >= imgList.length) currIdx = 0;

        const target = imgList[currIdx];
        const fullPath = target.path + target.file;

        // 이미지 교체 (페이드 효과를 주면 더 자연스럽습니다)
        $('#mainImg').css('opacity', '0.5');
        setTimeout(() => {
            $('#mainImg').attr('src', fullPath);
            $('#mainImg').css('opacity', '1');
            updateImgTag();
        }, 150);
    }

    function updateImgTag() {
        const total = imgList.length > 0 ? imgList.length : 1;
        $('#imgTag').text((currIdx + 1) + ' / ' + total);
    }
    </script>
</body>
</html>